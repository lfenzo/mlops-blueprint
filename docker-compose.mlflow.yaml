version: "3"

# necessary to set userns_mode: "keep-id" (used only for postgres)
# see https://github.com/containers/podman-compose/issues/166 for details
x-podman:
  in_pod: false

services:
  postgres-mlflow:
    image: postgres:latest
    env_file:
      - ./mlflow/data/.env
    ports:
      - 5432:5432
    volumes:
      - ./mlflow/data:/var/lib/postgresql/data:z
    userns_mode: "keep-id"

  minio:
    image: minio/minio:latest
    env_file:
      - ./mlflow/artifacts/.env
    ports:
      - 9000:9000  # S3 API port
      - 9001:9001  # web ui
    volumes:
      - ./mlflow/artifacts/data:/data:z
    command: server /data --console-address ":9001"

  mlflow:
    build:
      context: ./mlflow/server
    depend_on:
      - minio
      - postgres-mlflow
    ports:
      - 5000:5000
    env_file:
      - ./mlflow/server/.env
    command: [
      "mlflow",
      "server",
      "--backend-store-uri", "postgresql://postgres:postgres@postgres-mlflow/mlflow-backend-store",
      "--default-artifact-root", "s3://mlflow-artifacts",
      "--host", "0.0.0.0"
    ]
